#!/bin/bash
#SBATCH --job-name=matmul_benchmark
#SBATCH --output=matmul_benchmark.out
#SBATCH --error=matmul_benchmark.err
#SBATCH --partition=interactive
#SBATCH --gres=gpu:1
#SBATCH --time=00:30:00
#SBATCH --mem=16G

# Load modules
module load nvidia/cuda/12.2.0
module load gcc/11.3.0
module load conda/miniforge/23.1.0

# Fix conda shell hook
eval "$(conda shell.bash hook)"
conda activate myenv

# Fix CUDA_HOME
export CUDA_HOME=$(dirname $(dirname $(which nvcc)))

# Optional: confirm CUDA
nvcc --version
echo "CUDA_HOME=$CUDA_HOME"

# Install dependencies (optional if already installed)
pip install --upgrade pip
pip install torch numpy

# Build CUDA extension
python setup.py build_ext --inplace

# Run the benchmark
python matmul_bench.py

